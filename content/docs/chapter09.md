---
title: "Chapter 9: 포지션 크기 결정"
weight: 9
bookToc: true
---

# Chapter 9: 포지션 크기 결정

아무리 좋은 전략이라도 포지션 크기를 잘못 결정하면 큰 손실을 입거나 기회를 놓칠 수 있습니다. 이번 챕터에서는 계좌 크기와 위험 허용도에 맞게 포지션 크기를 결정하는 다양한 방법을 배웁니다.

## 9.1 포지션 크기의 중요성

### 9.1.1 포지션 크기가 중요한 이유

**1. 위험 관리의 핵심**
- 너무 큰 포지션: 한 번의 손실로 계좌 파산 가능
- 너무 작은 포지션: 수익 기회 미활용

**2. 복리 효과**
- 일정한 포지션 크기 유지 시 복리 효과 극대화
- 계좌 크기에 비례하여 포지션 조정

**3. 심리적 안정**
- 적절한 포지션 크기로 감정적 의사결정 방지
- 손실을 견딜 수 있는 수준 유지

### 9.1.2 포지션 크기의 기본 원칙

**원칙 1: 한 번의 거래로 전체 계좌의 1-2% 이상 위험에 노출하지 않기**
```
예: 계좌 $10,000
→ 거래당 최대 위험: $100-$200
```

**원칙 2: 계좌 크기에 비례하여 포지션 조정**
```
계좌 $10,000 → 포지션 $9,500
계좌 $20,000 → 포지션 $19,000
```

**원칙 3: 변동성에 따라 포지션 크기 조정**
```
고변동성 자산 → 작은 포지션
저변동성 자산 → 큰 포지션
```

## 9.2 포지션 크기 결정 방법

### 9.2.1 고정 금액 (Fixed Amount)

**방법**: 매번 동일한 금액 투자

```python
position_size = fixed_amount  # 예: $5,000
shares = position_size / current_price
```

**장점**:
- 단순하고 이해하기 쉬움
- 구현 간단

**단점**:
- 계좌 크기 변화 무시
- 복리 효과 없음
- 위험 관리 어려움

**적용 사례**: 초보자, 소액 계좌

### 9.2.2 고정 비율 (Fixed Percentage)

**방법**: 계좌 크기의 일정 비율 투자

```python
position_size = account_value * percentage  # 예: 95%
shares = position_size / current_price
```

**장점**:
- 계좌 크기에 비례하여 자동 조정
- 복리 효과 발생
- 구현 간단

**단점**:
- 변동성 고려 없음
- 연속 손실 시 빠른 계좌 감소

**적용 사례**: 가장 일반적인 방법, 장기 투자

### 9.2.3 고정 위험 (Fixed Risk)

**방법**: 거래당 위험을 계좌의 일정 비율로 제한

$$
\text{Position Size} = \frac{\text{Account Value} \times \text{Risk \%}}{\text{Entry Price} - \text{Stop Loss Price}}
$$

**예시**:
```
계좌: $10,000
위험 허용: 1% → $100
진입가: $100
손절가: $95
손실폭: $5

포지션 크기 = $100 / $5 = 20주
투자금액 = 20주 × $100 = $2,000
```

**장점**:
- 명확한 위험 관리
- 손실을 정확히 제어
- 변동성 자동 반영

**단점**:
- 손절매 필수
- 계산 복잡

**적용 사례**: 전문 트레이더, 단기 매매

### 9.2.4 켈리 기준 (Kelly Criterion)

**방법**: 최적 성장률을 위한 수학적 공식

$$
f^* = \frac{p \cdot (b + 1) - 1}{b}
$$

또는 더 간단하게:

$$
f^* = \frac{W - (1 - W)}{R}
$$

여기서:
- $f^*$: 투자할 자본 비율
- $W$: 승률 (Win Rate)
- $R$: 평균 승리/평균 손실 비율 (Reward/Risk Ratio)
- $p$: 승률
- $b$: 배당률 (net odds)

**예시**:
```
승률 (W) = 60% = 0.6
평균 수익 = $300
평균 손실 = $150
R = $300 / $150 = 2

Kelly % = (0.6 - (1-0.6)) / 2 = (0.6 - 0.4) / 2 = 0.1 = 10%
```

**장점**:
- 이론적으로 최적의 성장률
- 장기적으로 복리 최대화

**단점**:
- 실전에서는 너무 공격적
- 승률과 손익비 정확한 추정 필요
- 변동성이 큼

**개선: Half-Kelly 또는 Quarter-Kelly**
```python
kelly_percentage = (win_rate - (1 - win_rate)) / reward_risk_ratio
safe_percentage = kelly_percentage * 0.5  # Half-Kelly
```

**적용 사례**: 경험 많은 트레이더, 안정적인 전략

### 9.2.5 변동성 기반 (Volatility-Based)

**방법**: ATR(Average True Range)를 사용한 변동성 고려

$$
\text{Position Size} = \frac{\text{Account Value} \times \text{Risk \%}}{\text{ATR} \times \text{ATR Multiplier}}
$$

**예시**:
```
계좌: $10,000
위험 허용: 1% → $100
ATR(14) = $5
ATR 배수 = 2 (손절매 = 진입가 - 2×ATR)

포지션 크기 = $100 / ($5 × 2) = 10주
```

**장점**:
- 시장 변동성 자동 반영
- 동적 위험 조정
- 다양한 자산 비교 가능

**단점**:
- ATR 계산 필요
- 구현 복잡

**적용 사례**: 다양한 자산 거래, 변동성 큰 시장

## 9.3 Backtrader에서 포지션 크기 관리

### 9.3.1 Sizer 클래스

Backtrader는 `Sizer` 클래스를 통해 포지션 크기를 관리합니다:

```python
# 고정 비율
cerebro.addsizer(bt.sizers.PercentSizer, percents=95)

# 고정 수량
cerebro.addsizer(bt.sizers.FixedSize, stake=100)

# 고정 위험 (커스텀 구현 필요)
cerebro.addsizer(FixedRiskSizer, risk_percent=1.0)
```

### 9.3.2 커스텀 Sizer 구현

```python
class FixedRiskSizer(bt.Sizer):
    params = (
        ('risk_percent', 1.0),  # 위험 비율 (%)
    )

    def _getsizing(self, comminfo, cash, data, isbuy):
        if isbuy:
            # 계좌 크기
            account_value = self.broker.getvalue()

            # 위험 금액
            risk_amount = account_value * (self.params.risk_percent / 100)

            # 진입가와 손절가 (전략에서 설정)
            entry_price = data.close[0]
            stop_loss = self.strategy.stop_loss_price

            # 주당 위험
            risk_per_share = entry_price - stop_loss

            if risk_per_share > 0:
                # 포지션 크기 계산
                position_size = risk_amount / risk_per_share
                return int(position_size)

        return 0
```

## 9.4 실전 구현

이번 챕터의 코드에서는 다음을 구현합니다:

1. **고정 비율 전략**: 95% 투자
2. **고정 위험 전략**: 거래당 1% 위험
3. **켈리 기준 전략**: Half-Kelly 방법
4. **변동성 기반 전략**: ATR 기반 포지션 크기
5. **성과 비교**: 각 방법의 수익률, 위험, Sharpe Ratio

## 9.5 기대 결과

코드를 실행하면 다음을 확인할 수 있습니다:

1. **계좌 성장 곡선**: 각 포지션 크기 방법별 계좌 가치 변화
2. **포지션 크기 변화**: 시간에 따른 포지션 크기 조정
3. **위험 지표**:
   - 최대 낙폭 (Maximum Drawdown)
   - 변동성 (Volatility)
   - Sharpe Ratio
4. **거래 통계**: 평균 포지션 크기, 최대/최소 포지션
5. **비교 분석**: 어떤 방법이 가장 안정적이고 수익성이 높은가?

## 9.6 분석 포인트

코드를 실행한 후 다음을 분석해보세요:

1. **위험 조정 수익**: 높은 수익률보다 Sharpe Ratio가 중요
2. **최대 낙폭**: 감내할 수 있는 수준인가?
3. **계좌 성장 안정성**: 부드러운 성장 vs. 급등락
4. **포지션 크기 변화**: 시장 변동성에 적절히 반응하는가?
5. **복리 효과**: 고정 비율 방법의 복리 효과 확인

## 9.7 포지션 크기 결정 시 주의사항

### 9.7.1 과도한 레버리지 피하기

**문제**: 켈리 기준이 20%를 제안해도 너무 공격적

**해결책**: Half-Kelly 또는 Quarter-Kelly 사용
```python
kelly = 0.20
safe_kelly = kelly * 0.5  # 10%
```

### 9.7.2 연속 손실 대비

**문제**: 연속 손실 시 계좌 급감

**해결책**: 최대 손실 제한 설정
```python
if consecutive_losses >= 3:
    position_size *= 0.5  # 포지션 크기 절반으로 축소
```

### 9.7.3 승률과 손익비 변화

**문제**: 과거 데이터 기반 켈리 계산이 미래에 맞지 않음

**해결책**:
- 보수적 추정 사용
- 주기적으로 재계산
- 실시간 성과 모니터링

### 9.7.4 유동성 고려

**문제**: 계산된 포지션 크기가 시장 유동성 초과

**해결책**:
```python
daily_volume = data.volume[0]
max_position = daily_volume * 0.01  # 일일 거래량의 1%
position_size = min(calculated_size, max_position)
```

## 9.8 실전 적용 가이드

### 9.8.1 초보자 권장 설정

```python
# 보수적 접근
position_size = account_value * 0.50  # 50% 투자
risk_per_trade = account_value * 0.01  # 1% 위험
```

### 9.8.2 중급자 권장 설정

```python
# 균형 잡힌 접근
position_size = account_value * 0.80  # 80% 투자
risk_per_trade = account_value * 0.015  # 1.5% 위험
```

### 9.8.3 전문가 권장 설정

```python
# 공격적 접근 (Half-Kelly)
kelly = (win_rate - (1 - win_rate)) / reward_risk_ratio
position_size = account_value * kelly * 0.5
risk_per_trade = account_value * 0.02  # 2% 위험
```

## 9.9 포지션 크기 최적화

### 9.9.1 백테스팅을 통한 최적화

다양한 포지션 크기로 백테스트:
```python
for position_percent in [0.25, 0.50, 0.75, 0.95]:
    # 백테스트 실행
    # Sharpe Ratio 및 Max Drawdown 비교
```

**최적화 목표**:
- 최대 Sharpe Ratio
- 최소 Drawdown
- 목표 수익률 달성

### 9.9.2 동적 포지션 조정

시장 환경에 따라 포지션 크기 조정:
```python
if market_volatility > threshold:
    position_size *= 0.7  # 변동성 높을 때 축소
else:
    position_size *= 1.0  # 정상
```

## 9.10 실행 결과

실제로 스크립트를 실행한 결과입니다:

```
============================================================
Chapter 9: 포지션 크기 결정
============================================================

=== 백테스트 설정 ===
- 티커: AAPL
- 기간: 2019-01-01 ~ 2024-01-01
- 초기 자금: $10,000.00
- 전략: SMA(50/200) 크로스오버

============================================================
백테스트 실행 중...
============================================================

[1/4] 고정 비율 (95%) 전략...

============================================================
=== 고정 비율 (95%) ===
============================================================

총 수익률: +11.07%
최종 자금: $11,106.95
Sharpe Ratio: 0.266
Max Drawdown: 14.41%
거래 횟수: 2, 승률: 0.0%

[2/4] 고정 비율 (50%) 전략...

============================================================
=== 고정 비율 (50%) ===
============================================================

총 수익률: +6.24%
최종 자금: $10,623.54
Sharpe Ratio: 0.266
Max Drawdown: 8.31%
거래 횟수: 2, 승률: 0.0%

[3/4] 고정 위험 (1%) 전략...

============================================================
=== 고정 위험 (1%) ===
============================================================

총 수익률: +3.04%
최종 자금: $10,303.77
Sharpe Ratio: 0.311
Max Drawdown: 3.64%
거래 횟수: 2, 승률: 0.0%

[4/4] 켈리 기준 (Half-Kelly) 전략...

============================================================
=== 켈리 기준 (Half-Kelly) ===
============================================================

총 수익률: +0.43%
최종 자금: $10,042.92
Sharpe Ratio: 0.277
Max Drawdown: 0.58%
거래 횟수: 2, 승률: 0.0%

============================================================
=== 포지션 크기 방법 비교 요약 ===
============================================================

방법                            수익률     Sharpe        MDD
------------------------------------------------------------
고정 비율 (95%)                11.07%      0.27     14.41%
고정 비율 (50%)                 6.24%      0.27      8.31%
고정 위험 (1%)                  3.04%      0.31      3.64%
Kelly (Half)                0.43%      0.28      0.58%
```

![포지션 크기 결정](/images/chapter09/position_sizing.png)

### 차트 해석

**패널 1: 계좌 가치 변화**
- 4가지 포지션 크기 방법의 계좌 가치 추이 비교
- **고정 비율 95%** (파란색): 가장 높은 수익률 (+11.07%)이지만 가장 큰 변동성
- **고정 비율 50%** (주황색): 중간 수익률 (+6.24%), 변동성 절반 감소
- **고정 위험 1%** (녹색): 보수적 수익률 (+3.04%), 매우 안정적
- **Kelly Half** (빨간색): 가장 낮은 수익률 (+0.43%), 최소 변동성

**패널 2: Drawdown 비교**
- 각 방법의 최대 낙폭 시각화
- **고정 비율 95%**: 최대 14.41% 하락 - 심리적으로 부담될 수 있는 수준
- **고정 비율 50%**: 8.31% 하락 - 절반 투자로 손실도 절반
- **고정 위험 1%**: 3.64% 하락 - 안정적이지만 기회비용 큼
- **Kelly Half**: 0.58% 하락 - 거의 손실 없지만 수익도 미미

**패널 3: 포지션 크기 변화**
- 시간에 따른 포지션 크기 (주식 수) 변화
- 고정 비율 방법은 계좌 가치에 비례하여 포지션 조정 (복리 효과)
- 고정 위험/Kelly 방법은 시장 변동성에 따라 동적 조정
- 변동성 높을 때 포지션 자동 축소 = 위험 관리

**패널 4: 위험-수익 산점도**
- X축: Maximum Drawdown (위험)
- Y축: 총 수익률 (수익)
- **이상적 위치**: 왼쪽 상단 (낮은 위험, 높은 수익)
- **관찰**: 고정 비율 95%가 가장 높은 수익이지만 위험도 가장 높음
- **트레이드오프**: 더 높은 수익을 원하면 더 큰 위험 감수 필요

### 성과 분석 및 핵심 인사이트

#### 1. 포지션 크기와 수익률의 관계

**결과 요약**:
| 방법 | 수익률 | Sharpe Ratio | Max DD | 최종 자금 |
|------|--------|--------------|--------|----------|
| 고정 비율 95% | +11.07% | 0.266 | 14.41% | $11,106.95 |
| 고정 비율 50% | +6.24% | 0.266 | 8.31% | $10,623.54 |
| 고정 위험 1% | +3.04% | 0.311 | 3.64% | $10,303.77 |
| Kelly Half | +0.43% | 0.277 | 0.58% | $10,042.92 |

**관찰**:
- 포지션 크기가 클수록 수익률과 위험 모두 증가
- 고정 비율 50%는 95%의 56% 수익 (정확히 절반은 아님)
- 수익률은 선형적이지 않고 복리 효과와 변동성에 영향받음

#### 2. 리스크 조정 수익률 (Sharpe Ratio)

**고정 위험 1%가 최고 Sharpe Ratio (0.311)**:
- 변동성 대비 가장 효율적인 수익
- 절대 수익률은 낮지만 위험을 고려하면 가장 우수
- 실전에서는 Sharpe Ratio가 더 중요한 지표

**Sharpe Ratio 해석**:
- 0.27-0.31: 모두 보통 수준 (1.0 이상이 우수)
- 전략 자체 (SMA 크로스오버)의 성과가 제한적
- 좋은 전략 + 적절한 포지션 크기 = 높은 Sharpe

#### 3. Maximum Drawdown의 중요성

**감내할 수 있는 수준인가?**:
- **14.41%** (95%): 많은 투자자에게 심리적 부담
- **8.31%** (50%): 대부분 감내 가능
- **3.64%** (1%): 매우 안정적, 초보자 적합
- **0.58%** (Kelly): 거의 없음, 하지만 수익도 미미

**실전 적용**:
- 자신의 손실 허용도를 먼저 파악
- "얼마 잃으면 잠을 못 자는가?" 질문
- Max DD < 20%를 일반적 목표로 설정

#### 4. 켈리 기준의 실전 적용

**Kelly가 가장 낮은 수익률을 보인 이유**:
- 전략의 승률이 낮아 (2회 거래, 승률 0%) Kelly 값이 매우 보수적으로 계산됨
- Half-Kelly는 Full Kelly의 절반으로 더욱 보수적
- **교훈**: 과거 성과가 불확실하면 Kelly는 극도로 조심스러워짐

**Kelly의 장단점**:
- **장점**: 이론적으로 최적의 장기 복리 성장
- **단점**: 승률/손익비 추정이 정확해야 함, 실전에서는 과거 데이터 사용
- **권장**: 항상 Half-Kelly 또는 Quarter-Kelly 사용

#### 5. 복리 효과 관찰

**고정 비율 방법의 복리**:
- 수익 발생 시 다음 거래의 포지션 크기 증가
- 손실 발생 시 다음 거래의 포지션 크기 감소
- 장기적으로 계좌 성장 가속화

**복리의 양면성**:
- ✅ 수익 시 더 빠른 성장
- ❌ 손실 시 더 빠른 감소
- 연속 손실이 치명적일 수 있음

#### 6. 포지션 크기 선택 가이드

**목표에 따른 선택**:

- **공격적 성장 추구**: 고정 비율 80-95%
  - 높은 수익 기대
  - 변동성 감내 필요
  - 충분한 경험과 자금 필요

- **균형 잡힌 접근**: 고정 비율 50-70%
  - 적절한 수익과 위험 균형
  - 대부분의 투자자에게 적합
  - 권장 시작점

- **보수적 운용**: 고정 위험 1%
  - 안정적 계좌 성장
  - 초보자, 큰 자금 적합
  - 심리적 안정감

- **초보수적**: Kelly (Half/Quarter)
  - 최소 위험
  - 전략 검증 단계
  - 실전 경험 부족 시

#### 7. 실전 적용 시 고려사항

**포지션 크기 결정 체크리스트**:
- [ ] 계좌 크기: 작은 계좌는 더 보수적으로
- [ ] 경험 수준: 초보자는 50% 이하
- [ ] 위험 허용도: 손실 견딜 수 있는 범위 확인
- [ ] 전략 신뢰도: 검증된 전략은 더 공격적으로
- [ ] 시장 환경: 불확실할 때는 축소
- [ ] 다각화: 다른 전략/자산에도 분산 필요

**동적 조정 전략**:
```python
# 예시: 연속 손실 시 포지션 축소
if consecutive_losses >= 3:
    position_percent *= 0.5  # 절반으로 축소
elif consecutive_wins >= 5:
    position_percent = min(original_percent, position_percent * 1.2)  # 점진적 증가
```

#### 8. 이 테스트의 한계

**주의사항**:
- SMA 크로스오버는 2회만 거래 (샘플 적음)
- 더 많은 거래가 있는 전략에서는 결과가 다를 수 있음
- 단일 종목 (AAPL)에만 테스트
- 2019-2024 특정 기간에 최적화됨

**권장사항**:
- 여러 종목, 여러 기간에서 테스트
- 최소 30회 이상 거래가 있는 전략으로 검증
- 실전 투입 전 충분한 샘플 외 검증

#### 9. 최종 권장사항

**초보자**: 고정 비율 50% + 거래당 위험 1%
- 균형 잡힌 접근
- 충분한 경험 쌓기
- Max DD 10% 이하 목표

**중급자**: 고정 비율 70-80% + 거래당 위험 1.5%
- 검증된 전략 운용
- Max DD 15% 이하 목표
- 시장 환경에 따라 동적 조정

**전문가**: 고정 비율 + Kelly 결합
- 전략별 최적 포지션 계산
- 복수 전략 포트폴리오 운용
- 실시간 리스크 모니터링

## 9.11 개선 방향

포지션 크기 전략을 더욱 개선하는 방법:

1. **다중 자산 포트폴리오**: 자산별 최적 포지션 배분
2. **상관관계 고려**: 상관관계 높은 자산은 합산 위험 계산
3. **시장 체제 인식**: 상승장/하락장/횡보장별 다른 설정
4. **머신러닝 통합**: 최적 포지션 크기 학습
5. **실시간 조정**: 실시간 변동성 및 위험에 따라 동적 조정

## 다음 단계

다음 챕터에서는 손절매(Stop Loss)와 익절매(Take Profit)를 포함한 종합적인 리스크 관리 기법을 배웁니다. 포지션 크기 결정만큼이나 중요한 것이 언제 손실을 확정하고 이익을 실현할 것인가입니다.

---

**코드 실행:**
```bash
cd codes
uv run chapter09/01_position_sizing.py
```
