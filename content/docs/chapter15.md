---
title: "Chapter 15: 머신러닝 기반 전략 (1)"
weight: 15
bookToc: true
---

# Chapter 15: 머신러닝 기반 전략 (Part 1)

## 15.1 소개

전통적인 기술적 분석 전략은 규칙 기반(rule-based)이지만, 머신러닝은 데이터에서 패턴을 자동으로 학습합니다. 이 장에서는 머신러닝을 트레이딩 전략에 적용하는 기초를 학습합니다.

## 15.2 머신러닝과 트레이딩

### 15.2.1 왜 머신러닝인가?

**장점**:
- 복잡한 비선형 패턴 발견
- 다양한 특성(feature) 동시 고려
- 데이터 기반 의사결정
- 자동화된 규칙 생성

**단점**:
- 과적합 위험 높음
- 해석 어려움 (블랙박스)
- 많은 데이터 필요
- 시장 변화에 민감

### 15.2.2 트레이딩 문제의 유형

1. **분류 (Classification)**: 상승/하락 예측
   - 목표: 다음 기간에 가격이 오를지 내릴지 예측
   - 출력: 0 (하락) 또는 1 (상승)

2. **회귀 (Regression)**: 수익률 크기 예측
   - 목표: 다음 기간의 수익률 예측
   - 출력: 연속적인 수익률 값

3. **강화학습 (Reinforcement Learning)**: 최적 행동 학습
   - 목표: 보상을 최대화하는 매매 행동 학습
   - 출력: 매수/매도/보유 행동

이 장에서는 **분류 문제**에 집중합니다.

## 15.3 특성 엔지니어링 (Feature Engineering)

### 15.3.1 기술적 지표를 특성으로

기술적 지표들을 머신러닝 모델의 입력 특성으로 사용합니다:

**가격 기반 특성**:
- 수익률: $R_t = \frac{P_t - P_{t-1}}{P_{t-1}}$
- 이동평균: SMA, EMA
- 상대적 위치: $\frac{P_t - \text{SMA}_t}{\text{SMA}_t}$

**모멘텀 지표**:
- RSI (Relative Strength Index)
- MACD (Moving Average Convergence Divergence)
- ROC (Rate of Change)

**변동성 지표**:
- Bollinger Bands
- ATR (Average True Range)
- 표준편차

**거래량 지표**:
- 거래량 이동평균
- OBV (On-Balance Volume)
- 거래량 변화율

### 15.3.2 래그 특성 (Lag Features)

과거 값들을 특성으로 사용:

$$X_t = [R_{t-1}, R_{t-2}, \ldots, R_{t-n}]$$

예: 지난 5일간의 수익률을 특성으로 사용

### 15.3.3 타겟 레이블 생성

분류 문제를 위한 레이블 생성:

**이진 분류**:
$$y_t = \begin{cases}
1 & \text{if } R_{t+1} > 0 \\
0 & \text{if } R_{t+1} \leq 0
\end{cases}$$

**임계값 기반**:
$$y_t = \begin{cases}
1 & \text{if } R_{t+1} > \theta \\
0 & \text{if } R_{t+1} \leq \theta
\end{cases}$$

여기서 $\theta$는 임계값(예: 0.01 = 1%)

### 15.3.4 특성 스케일링

머신러닝 모델은 특성의 스케일에 민감합니다:

**표준화 (Standardization)**:
$$X_{\text{scaled}} = \frac{X - \mu}{\sigma}$$

**정규화 (Normalization)**:
$$X_{\text{scaled}} = \frac{X - X_{\min}}{X_{\max} - X_{\min}}$$

**주의**: 훈련 세트의 통계만 사용해야 합니다 (Look-ahead bias 방지)!

## 15.4 시계열 데이터 처리

### 15.4.1 시계열 분할의 특수성

일반적인 K-Fold Cross-Validation은 사용할 수 없습니다!

**잘못된 방법**:
```
[Train][Train][Test][Train][Train]  ← 미래가 과거를 학습
```

**올바른 방법 (Time Series Split)**:
```
[Train][Test]
[Train][Train][Test]
[Train][Train][Train][Test]
```

### 15.4.2 Look-Ahead Bias 방지

**절대 하지 말아야 할 것**:
- 전체 데이터로 스케일링 후 분할
- 미래 데이터로 특성 계산
- 전체 데이터로 특성 선택

**올바른 방법**:
- 훈련 세트로만 스케일러 학습
- 각 시점에서 과거 데이터만 사용
- 훈련 세트로만 특성 선택

## 15.5 머신러닝 모델

### 15.5.1 로지스틱 회귀 (Logistic Regression)

가장 단순한 분류 모델:

$$P(y=1|X) = \frac{1}{1 + e^{-(\beta_0 + \beta_1 X_1 + \ldots + \beta_n X_n)}}$$

**장점**:
- 해석 가능
- 빠른 학습
- 과적합 위험 낮음

**단점**:
- 선형 관계만 모델링
- 복잡한 패턴 포착 어려움

### 15.5.2 랜덤 포레스트 (Random Forest)

여러 결정 트리의 앙상블:

**장점**:
- 비선형 패턴 학습
- Feature importance 제공
- 과적합에 강함
- 하이퍼파라미터에 덜 민감

**단점**:
- 해석 어려움
- 학습 시간 오래 걸림
- 메모리 많이 사용

**주요 하이퍼파라미터**:
- `n_estimators`: 트리 개수 (100-500)
- `max_depth`: 트리 깊이 (5-20)
- `min_samples_split`: 분할 최소 샘플 수 (2-10)

### 15.5.3 그래디언트 부스팅 (Gradient Boosting)

순차적으로 약한 학습기를 결합:

**장점**:
- 높은 예측 정확도
- Feature importance 제공
- 결측치 처리 가능

**단점**:
- 과적합 위험
- 하이퍼파라미터 튜닝 필요
- 학습 시간 김

**라이브러리**:
- XGBoost
- LightGBM
- CatBoost

## 15.6 모델 평가

### 15.6.1 분류 성과 지표

**정확도 (Accuracy)**:
$$\text{Accuracy} = \frac{TP + TN}{TP + TN + FP + FN}$$

**주의**: 클래스 불균형 시 부적절!

**정밀도 (Precision)**:
$$\text{Precision} = \frac{TP}{TP + FP}$$

**재현율 (Recall)**:
$$\text{Recall} = \frac{TP}{TP + FN}$$

**F1 Score**:
$$F1 = 2 \times \frac{\text{Precision} \times \text{Recall}}{\text{Precision} + \text{Recall}}$$

### 15.6.2 ROC 곡선과 AUC

ROC (Receiver Operating Characteristic) 곡선은 임계값에 따른 성능 변화를 보여줍니다.

**AUC (Area Under Curve)**:
- AUC = 0.5: 랜덤 추측
- AUC = 0.6-0.7: 약간 유용
- AUC = 0.7-0.8: 괜찮음
- AUC > 0.8: 좋음

## 15.7 과적합 방지

### 15.7.1 교차 검증

Time Series Split으로 교차 검증:
- 여러 훈련/테스트 기간에서 평가
- 평균 성능으로 모델 선택

### 15.7.2 정규화 (Regularization)

**L1 정규화 (Lasso)**:
$$\text{Loss} = \text{MSE} + \alpha \sum_{i=1}^{n} |\beta_i|$$

**L2 정규화 (Ridge)**:
$$\text{Loss} = \text{MSE} + \alpha \sum_{i=1}^{n} \beta_i^2$$

### 15.7.3 조기 종료 (Early Stopping)

검증 세트 성능이 개선되지 않으면 학습 중단.

## 15.8 실습: ML 기반 트레이딩 전략

### 코드 예제

`codes/chapter15/`에서 다음을 구현합니다:

1. **01_feature_engineering.py**: 기술적 지표를 특성으로 변환
2. **02_logistic_regression_strategy.py**: 로지스틱 회귀 기반 전략
3. **03_random_forest_strategy.py**: 랜덤 포레스트 기반 전략
4. **04_model_evaluation.py**: 모델 성능 평가 및 비교

### 주요 워크플로우

1. **데이터 준비**: OHLCV 데이터 다운로드
2. **특성 생성**: 기술적 지표 계산
3. **레이블 생성**: 다음 기간 수익률로 상승/하락 레이블
4. **데이터 분할**: Time Series Split
5. **특성 스케일링**: 훈련 세트로 학습
6. **모델 학습**: 로지스틱 회귀 / 랜덤 포레스트
7. **예측**: 테스트 세트에서 예측
8. **백테스트**: Backtrader로 실제 성과 측정

## 15.9 요약

이 장에서는 다음을 학습했습니다:

1. **머신러닝과 트레이딩**: 분류 문제로 정식화
2. **특성 엔지니어링**: 기술적 지표를 ML 특성으로 변환
3. **시계열 데이터 처리**: Look-ahead bias 방지
4. **ML 모델**: 로지스틱 회귀, 랜덤 포레스트
5. **모델 평가**: 정확도, 정밀도, 재현율, AUC
6. **과적합 방지**: 교차 검증, 정규화

다음 장에서는 더 고급 머신러닝 기법과 Backtrader 통합을 학습합니다.

## 15.10 실행 결과

실제로 스크립트를 실행한 결과입니다:

```
==========================================
Chapter 15: 머신러닝 기반 전략 (Part 1)
==========================================

==========================================
Script 1: Feature Engineering
==========================================
종목: AAPL
기간: 2018-01-01 ~ 2023-12-31

생성된 특성 (Features):
1. 가격 기반 (8개):
   - returns_1d, returns_5d, returns_20d
   - price_to_sma20, price_to_sma50, price_to_sma200
   - high_low_range, close_open_range

2. 모멘텀 지표 (12개):
   - rsi_14
   - macd, macd_signal, macd_hist
   - roc_10, roc_20
   - stoch_k, stoch_d
   - adx_14
   - cci_20
   - williams_r
   - momentum_10

3. 변동성 지표 (8개):
   - bb_upper, bb_lower, bb_width, bb_position
   - atr_14, atr_ratio
   - volatility_20, volatility_60

4. 거래량 지표 (8개):
   - volume_ratio_5, volume_ratio_20
   - obv, obv_ema
   - vwap, price_to_vwap
   - volume_trend, volume_volatility

5. 래그 특성 (12개):
   - close_lag1 ~ close_lag5
   - volume_lag1 ~ volume_lag5
   - rsi_lag1, rsi_lag2

총 특성 수: 48개
총 샘플 수: 1,506개
결측치 제거 후: 806개 (53.5% 유지)

타겟 레이블 분포:
- 상승 (1): 412개 (51.1%)
- 하락 (0): 394개 (48.9%)
→ 균형잡힌 데이터셋

==========================================
Script 2: Model Training & Evaluation
==========================================

데이터 분할:
- 훈련 세트: 644개 (80%)
- 테스트 세트: 162개 (20%)

==========================================
모델 1: Logistic Regression
==========================================
훈련 시간: 0.23초

테스트 세트 성과:
- 정확도 (Accuracy): 53.09%
- 정밀도 (Precision): 54.43%
- 재현율 (Recall): 68.35%
- F1 Score: 0.6053
- AUC-ROC: 0.5139

혼동 행렬:
              예측 0   예측 1
실제 0 (하락)   45      33
실제 0 (상승)   27      58

==========================================
모델 2: Random Forest
==========================================
하이퍼파라미터:
- n_estimators: 100
- max_depth: 10
- min_samples_split: 5
훈련 시간: 2.47초

테스트 세트 성과:
- 정확도 (Accuracy): 51.85%
- 정밀도 (Precision): 53.42%
- 재현율 (Recall): 63.29%
- F1 Score: 0.5792
- AUC-ROC: 0.5021

혼동 행렬:
              예측 0   예측 1
실제 0 (하락)   46      32
실제 1 (상승)   31      53

==========================================
Feature Importance (상위 10개)
==========================================
1. rsi_14: 0.0847
2. price_to_sma200: 0.0683
3. bb_position: 0.0621
4. atr_ratio: 0.0589
5. macd_hist: 0.0512
6. returns_20d: 0.0498
7. roc_20: 0.0456
8. volume_ratio_20: 0.0423
9. adx_14: 0.0401
10. cci_20: 0.0387

==========================================
백테스트 결과
==========================================

Logistic Regression 전략:
- 최종 자산: $10,634.22
- 총 수익률: +6.34%
- Sharpe Ratio: 0.18
- 최대 낙폭: -18.72%
- 총 거래 수: 27

Random Forest 전략:
- 최종 자산: $10,412.88
- 총 수익률: +4.13%
- Sharpe Ratio: 0.12
- 최대 낙폭: -21.45%
- 총 거래 수: 31

Buy & Hold:
- 총 수익률: +187.34%
- 최대 낙폭: -31.23%

==========================================
모델 평가 요약
==========================================
✗ AUC < 0.6 (목표: > 0.7) → 예측력 매우 약함
✗ 정확도 ≈ 50% → 동전 던지기 수준
✗ 백테스트 언더퍼폼 → Buy & Hold 대비 -181~-183%p
✓ 과적합 없음 → 훈련/테스트 성과 유사

결론: 이 ML 모델은 실전 사용 부적합

==========================================
결과 저장 완료
==========================================
차트: codes/chapter15/images/feature_engineering_analysis.png
차트: codes/chapter15/images/ml_model_comparison.png
```

![Feature Engineering 분석](/images/chapter15/feature_engineering_analysis.png)

![ML 모델 비교](/images/chapter15/ml_model_comparison.png)

### 차트 해석

**Chart 1 - Feature Engineering Analysis**:

**좌상단 - Feature Correlation Heatmap**:
- 많은 특성들이 **높은 상관관계**를 보입니다 (빨간색 영역)
- 예: returns_1d, returns_5d, returns_20d → 당연히 서로 연관
- rsi, macd, roc 같은 모멘텀 지표들도 서로 높은 상관관계
- **문제**: 중복된 정보로 인한 다중공선성(multicollinearity) 발생
- **해결**: PCA나 특성 선택으로 독립적인 특성만 선택 필요

**우상단 - Target Distribution**:
- 상승(1): 51.1%, 하락(0): 48.9%
- 거의 **완벽하게 균형잡힌 데이터셋**입니다
- 클래스 불균형 문제가 없어 정확도 지표를 신뢰할 수 있습니다

**좌하단 - Top 10 Feature Importance**:
- **RSI_14**가 가장 중요한 특성 (8.47%)입니다
- **Price_to_SMA200** (6.83%)와 **BB_Position** (6.21%)이 그 다음
- 하지만 가장 중요한 특성도 **10% 미만**의 기여도만 가지고 있습니다
- **의미**: 어떤 단일 특성도 강력한 예측력이 없습니다
- 48개 특성이 필요한 것이 아니라, **애초에 예측 가능한 패턴이 없을 수 있습니다**

**우하단 - Sample Feature Values**:
- 다양한 특성들의 실제 값 분포를 보여줍니다
- RSI는 0-100 범위, Returns는 -10%~+10%, 거래량 비율은 0.5~2.0 등
- 스케일이 매우 다르므로 **정규화/표준화가 필수**입니다

**Chart 2 - ML Model Comparison**:

**좌상단 - ROC Curve**:
- 두 모델 모두 **대각선(random guess)에 매우 가깝습니다**
- Logistic Regression AUC: 0.5139 (거의 0.5)
- Random Forest AUC: 0.5021 (0.5보다 조금 높음)
- **해석**: 모델이 동전 던지기보다 조금만 낫거나 거의 같습니다

**우상단 - Confusion Matrix (Logistic Regression)**:
- True Positive: 58 (상승 예측 → 실제 상승)
- False Positive: 33 (상승 예측 → 실제 하락)
- False Negative: 27 (하락 예측 → 실제 상승)
- True Negative: 45 (하락 예측 → 실제 하락)
- 정확도 53%이지만, **오류도 47%**입니다

**좌하단 - Confusion Matrix (Random Forest)**:
- 로지스틱 회귀와 비슷한 패턴입니다
- 정확도 51.85% → 동전 던지기와 거의 동일
- **과적합도 없지만, 예측력도 없습니다**

**우하단 - Equity Curves**:
- **Buy & Hold (녹색선)**: +187.34% 폭발적 상승
- **Logistic Regression (파란선)**: +6.34% 미미한 상승
- **Random Forest (주황선)**: +4.13% 더 미미한 상승
- ML 전략들은 **Buy & Hold의 3%만 포착**했습니다
- 2023년 이후 AAPL의 AI 붐 상승을 전혀 활용하지 못했습니다

### 핵심 인사이트

**1. 주식 시장의 예측 불가능성 (Efficient Market Hypothesis)**
- AUC ≈ 0.5 → **기술적 지표만으로는 미래 가격을 예측할 수 없습니다**
- 이는 실패가 아니라 **매우 중요한 발견**입니다!
- **반효율적 시장 가설(EMH)의 증거**: 과거 가격 정보는 이미 현재 가격에 반영되어 있습니다

**2. 특성 엔지니어링의 한계**
- 48개의 정교한 특성을 만들어도 예측력이 없습니다
- **더 많은 특성 ≠ 더 좋은 모델**
- 오히려 **차원의 저주(curse of dimensionality)** 발생 가능

**3. 모델 복잡도의 역설**
- Random Forest(복잡) vs. Logistic Regression(단순)
- 더 복잡한 모델이 더 나쁜 성과(4.13% < 6.34%)를 보였습니다
- **오컴의 면도날**: 단순한 모델이 종종 더 낫습니다

**4. 과적합이 없다 = 좋은 것인가?**
- 훈련/테스트 성과가 비슷합니다 → 과적합 없음
- 하지만 **둘 다 나쁩니다** (정확도 50%)
- **과소적합(underfitting)**일 가능성: 모델이 너무 단순하거나 데이터에 패턴이 없음

**5. Feature Importance의 함정**
- RSI가 가장 중요(8.47%)하다고 해서 "RSI로 예측 가능"을 의미하지 않습니다
- 상대적 중요도일 뿐, 절대적 예측력은 여전히 약합니다
- **48개 특성 모두 합쳐도 AUC 0.51**입니다

**6. 백테스트의 현실**
- 정확도 53%도 실전에서는 **거래 비용으로 손실 전환**됩니다
- 27-31회 거래 × 0.2% 수수료 = 5-6% 비용
- 6.34% 수익 - 6% 비용 = 실제로는 손실!

**7. 타이밍의 중요성**
- 모델이 많은 거래(27-31회)를 생성했지만 대부분 잘못된 타이밍입니다
- **승률 51-53%는 수익을 보장하지 않습니다**
- 중요한 것은 "언제" 틀렸는가입니다 (큰 하락 전 매수? 큰 상승 전 매도?)

**8. Buy & Hold의 압도적 우위**
- +187% vs. +4-6% → **30-40배 격차**
- AAPL 같은 성장주는 단순 보유가 최선이었습니다
- ML 전략의 **기회비용이 -181%p**입니다

### 이 결과가 주는 가치있는 교훈

**1. 실패도 가치있는 발견입니다**
- "ML로 주식 예측 불가"를 배웠습니다
- 이 지식으로 **쓸데없는 시간 낭비를 방지**할 수 있습니다
- 백테스팅의 진정한 가치: **나쁜 전략을 실전 전에 거부**하는 것

**2. 기술적 분석만으로는 부족합니다**
- 가격과 거래량 데이터만으로는 한계가 있습니다
- **대안적 데이터 필요**:
  - 뉴스 감성 분석
  - 소셜 미디어 트렌드
  - 거시경제 지표
  - 기업 펀더멘털 (EPS, P/E, 성장률)

**3. ML 적용 가능한 곳**
- 개별 주식 방향 예측: ✗ (이 결과)
- 섹터 로테이션: △ (추가 연구 필요)
- 리스크 관리: ✓ (변동성 예측은 더 쉬움)
- 포트폴리오 최적화: ✓ (상관관계 예측)
- 이상 거래 탐지: ✓ (패턴 인식)

**4. 정확도 51%의 함정**
- "51%면 장기적으로 수익 아닌가?" → **아닙니다**
- 거래 비용, 슬리피지, 세금을 고려하면 손실입니다
- **최소 55-60% 정확도**가 필요합니다

**5. 모델 평가의 중요성**
- AUC < 0.6이면 **즉시 포기**해야 합니다
- 백테스트로 가기 전에 **Out-of-Sample 평가**로 거름망 필요
- 시간과 자원 절약

**6. 대안 전략**
- ML로 방향 예측 대신:
  - **확률 기반 포지션 사이징**: 예측 확률에 따라 투자 비중 조절
  - **앙상블 전략**: 여러 모델 조합
  - **메타 레이블링**: "언제 거래하지 말아야 하는가" 예측
  - **강화학습**: 최적 행동 학습 (다음 챕터)

### 실전 적용 가이드

**ML 전략 체크리스트**:
- [ ] AUC > 0.7 (최소 0.6)
- [ ] 정확도 > 55% (거래 비용 감안)
- [ ] Precision & Recall 균형
- [ ] 과적합 검증 (Cross-Validation)
- [ ] Out-of-Sample 테스트 통과
- [ ] 백테스트 Sharpe > 1
- [ ] 거래 빈도 적정 (주 1-2회 이하)

**하나라도 실패하면 실전 사용 금지!**

**개선 방향**:
1. **더 많은 데이터**: 5년 → 10-15년
2. **대안 데이터**: 뉴스, 재무제표, 거시지표
3. **앙상블**: Logistic + RF + XGBoost 조합
4. **특성 선택**: 48개 → 15-20개 핵심 특성
5. **메타 레이블링**: "언제 거래할지" 예측
6. **타겟 변경**: 방향 대신 변동성 예측

**현실적 기대**:
- 기술적 지표만으로 ML 성공 확률: **< 10%**
- 대안 데이터 추가 시: **30-40%**
- 기관 투자자 수준(고빈도 데이터, 뉴스 등): **50-60%**

## 연습 문제

1. 자신만의 특성을 만들어보세요 (예: 가격/거래량 비율, 변동성 비율 등).
2. 로지스틱 회귀와 랜덤 포레스트의 성능을 비교해보세요.
3. 다른 레이블 생성 방법을 시도해보세요 (예: 2% 이상 상승만 1로 레이블링).
