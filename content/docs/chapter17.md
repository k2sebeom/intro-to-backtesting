---
title: "Chapter 17: 실전 트레이딩 고려사항"
weight: 17
bookToc: true
---

# Chapter 17: 실전 트레이딩 고려사항

## 17.1 소개

백테스트에서 좋은 성과를 보인 전략이 실전에서 실패하는 경우가 많습니다. 이 장에서는 백테스트와 실전 사이의 간극을 줄이기 위한 현실적인 고려사항들을 학습합니다.

## 17.2 슬리피지 (Slippage)

### 17.2.1 슬리피지란?

슬리피지는 예상 체결 가격과 실제 체결 가격의 차이입니다:

$$\text{Slippage} = \text{Actual Fill Price} - \text{Expected Price}$$

**발생 원인**:
- 호가 스프레드 (Bid-Ask Spread)
- 시장 영향 (Market Impact)
- 주문 지연 (Order Latency)
- 부분 체결 (Partial Fills)

### 17.2.2 슬리피지 모델링

**고정 슬리피지**:
- 모든 거래에 고정 금액 또는 비율 적용
- 예: 0.05% 슬리피지

$$\text{Buy Price} = \text{Close Price} \times (1 + 0.0005)$$
$$\text{Sell Price} = \text{Close Price} \times (1 - 0.0005)$$

**변동 슬리피지**:
- 거래량, 변동성, 호가 스프레드에 비례

$$\text{Slippage} = k \times \frac{\text{ATR}}{\text{Price}} \times \frac{\text{Order Size}}{\text{Avg Volume}}$$

여기서 $k$는 조정 상수입니다.

### 17.2.3 Backtrader에서 슬리피지 설정

```python
cerebro.broker.set_slippage_perc(0.0005)  # 0.05% 슬리피지
```

또는 커스텀 슬리피지:

```python
cerebro.broker.set_slippage_fixed(0.05)  # 고정 $0.05
```

## 17.3 거래 비용

### 17.3.1 수수료 (Commission)

**유형**:
- **고정 수수료**: 거래당 고정 금액
- **비율 수수료**: 거래 금액의 일정 비율
- **티어 수수료**: 거래량에 따라 차등 적용

**일반적인 수수료율**:
- 주식: 0.1% - 0.3%
- 선물: $2 - $5 per contract
- 암호화폐: 0.1% - 0.5%

### 17.3.2 세금

**한국 주식**:
- 매도 시 증권거래세: 0.23% (2023년 기준)
- 양도소득세: 대주주 또는 해외주식

**미국 주식**:
- 양도소득세: 매년 또는 매도 시 정산

### 17.3.3 기타 비용

- **데이터 피드 비용**: 실시간 데이터
- **플랫폼 이용료**: 거래 플랫폼 월 사용료
- **대여 비용**: 공매도 시 주식 대여 비용
- **금융 비용**: 신용거래 시 이자

## 17.4 시장 영향 (Market Impact)

### 17.4.1 개념

대량 주문은 시장 가격을 움직입니다:

**영향 정도**:
$$\text{Impact} = \lambda \times \left(\frac{\text{Order Size}}{\text{Daily Volume}}\right)^{\alpha}$$

일반적으로 $\alpha \approx 0.5$ ~ $0.6$

### 17.4.2 영향 최소화 전략

**주문 분할**:
- 대량 주문을 여러 개의 작은 주문으로 분할
- TWAP (Time-Weighted Average Price)
- VWAP (Volume-Weighted Average Price)

**유동성 고려**:
- 거래량이 충분한 종목 선택
- 주문 크기를 일평균 거래량의 1-5% 이내로 제한

## 17.5 주문 유형

### 17.5.1 Market Order (시장가 주문)

즉시 체결되지만 슬리피지 위험 높음.

**장점**: 확실한 체결
**단점**: 불리한 가격에 체결 가능

### 17.5.2 Limit Order (지정가 주문)

특정 가격 이하/이상에서만 체결.

**장점**: 가격 통제
**단점**: 미체결 위험

$$\text{Buy}: \text{Price} \leq \text{Limit Price}$$
$$\text{Sell}: \text{Price} \geq \text{Limit Price}$$

### 17.5.3 Stop Order (손절 주문)

특정 가격에 도달하면 시장가로 전환.

**Stop Loss**:
$$\text{Trigger Price} = \text{Entry Price} \times (1 - \text{Stop Loss \%})$$

### 17.5.4 Stop-Limit Order

Stop 트리거 후 지정가 주문 실행.

**장점**: 가격 통제
**단점**: 갭 발생 시 미체결 위험

## 17.6 체결 가능성 (Fill Probability)

### 17.6.1 체결 지연

백테스트는 즉시 체결을 가정하지만, 실전에서는:
- 주문 전송 지연
- 거래소 매칭 지연
- 네트워크 지연

**모델링**:
```python
# 다음 봉에서 체결
self.buy()  # 현재 close 가격이 아닌 다음 open 가격에 체결
```

### 17.6.2 부분 체결

유동성 부족 시 주문이 부분적으로만 체결될 수 있습니다.

**모델링**:
- 주문 크기를 일평균 거래량의 일정 비율로 제한
- 체결률을 확률적으로 모델링

## 17.7 시장 체제 (Market Regime)

### 17.7.1 체제 유형

**추세 시장 (Trending Market)**:
- 명확한 상승/하락 추세
- 추세 추종 전략 유리

**횡보 시장 (Range-bound Market)**:
- 일정 범위 내 등락
- 평균 회귀 전략 유리

**고변동성 시장 (High Volatility Market)**:
- 급격한 가격 변동
- 리스크 관리 중요

### 17.7.2 체제 감지

**변동성 기반**:
$$\text{Regime} = \begin{cases}
\text{High Volatility} & \text{if } \sigma_t > \mu_\sigma + k \cdot \text{std}(\sigma) \\
\text{Low Volatility} & \text{otherwise}
\end{cases}$$

**추세 강도 기반**:
- ADX (Average Directional Index)
- ADX > 25: 강한 추세
- ADX < 20: 약한 추세 (횡보)

### 17.7.3 적응형 전략

시장 체제에 따라 전략 또는 파라미터를 조정:

```python
if market_regime == 'trending':
    use_trend_following_strategy()
elif market_regime == 'range_bound':
    use_mean_reversion_strategy()
```

## 17.8 실습: 현실적인 백테스트

### 코드 예제

`codes/chapter17/`에서 다음을 구현합니다:

1. **01_slippage_commission.py**: 슬리피지와 수수료 영향 분석
2. **02_order_types.py**: 다양한 주문 유형 비교
3. **03_market_regime.py**: 시장 체제 감지 및 적응형 전략
4. **04_realistic_simulation.py**: 모든 요소를 고려한 현실적 시뮬레이션

### 주요 결과

일반적으로:
- 수수료 0.1% 추가 시 연수익률 2-5% 감소
- 슬리피지 0.05% 추가 시 연수익률 1-3% 감소
- 체결 지연 모델링 시 승률 5-10% 감소

## 17.9 백테스트 vs. 실전 체크리스트

**백테스트에 반영해야 할 요소**:
- [ ] 수수료 (최소 0.1%)
- [ ] 슬리피지 (최소 0.05%)
- [ ] 체결 지연 (다음 봉 open 가격)
- [ ] 주문 크기 제한 (일평균 거래량의 5% 이내)
- [ ] 세금 (해당 시)
- [ ] 갭 (Gap) 고려

**실전에서 추가로 고려**:
- [ ] 시스템 다운타임
- [ ] API 속도 제한
- [ ] 계좌 잔고 부족
- [ ] 규제 변경
- [ ] 거래소 점검

## 17.10 페이퍼 트레이딩

실전 배포 전에 페이퍼 트레이딩(모의 거래) 필수:

**기간**: 최소 3개월
**목적**:
- 시스템 안정성 확인
- 슬리피지 실측
- 심리적 적응

## 17.11 요약

이 장에서는 다음을 학습했습니다:

1. **슬리피지**: 원인, 모델링, 영향
2. **거래 비용**: 수수료, 세금, 기타 비용
3. **시장 영향**: 대량 주문의 가격 영향
4. **주문 유형**: Market, Limit, Stop Order
5. **체결 가능성**: 지연, 부분 체결
6. **시장 체제**: 감지 및 적응형 전략
7. **현실적 시뮬레이션**: 모든 요소를 고려한 백테스트

다음 장에서는 완전한 전략 개발 프로세스를 종합적으로 학습합니다.

## 17.12 실행 결과

실제로 스크립트를 실행한 결과입니다:

```
==========================================
Chapter 17: 실전 트레이딩 고려사항
==========================================
테스트 기간: 2020-01-01 ~ 2024-12-31 (NVDA)
전략: SMA 50/200 골든크로스

==========================================
거래 비용 영향 분석
==========================================

시나리오 1: 이상적 백테스트 (비용 없음)
- 수수료: 0.00%
- 슬리피지: 0.00%
- 최종 자산: $10,002.98
- 총 수익률: +0.03%
- Sharpe Ratio: 0.01
- 총 거래 수: 1

시나리오 2: 최소 비용
- 수수료: 0.05%
- 슬리피지: 0.02%
- 최종 자산: $10,002.28
- 총 수익률: +0.02%
- 거래 비용 영향: -0.01%

시나리오 3: 일반 소매 투자자
- 수수료: 0.10%
- 슬리피지: 0.05%
- 최종 자산: $10,001.48
- 총 수익률: +0.01%
- 거래 비용 영향: -0.02%

시나리오 4: 높은 비용
- 수수료: 0.20%
- 슬리피지: 0.10%
- 최종 자산: $10,000.98
- 총 수익률: +0.01%
- 거래 비용 영향: -0.02%

시나리오 5: 빈번한 거래 (데이 트레이더)
- 수수료: 0.10%
- 슬리피지: 0.15%
- 최종 자산: $9,999.98
- 총 수익률: -0.00%
- 거래 비용 영향: -0.03%

시나리오 6: 극단적 슬리피지
- 수수료: 0.10%
- 슬리피지: 0.50%
- 최종 자산: $9,996.98
- 총 수익률: -0.03%
- 거래 비용 영향: -0.06%

==========================================
거래 비용 민감도 분석
==========================================

총 거래 수: 1회
→ 거래 빈도가 매우 낮아 비용 영향 미미

거래당 평균 비용:
- 시나리오 2: $0.70 (0.07%)
- 시나리오 3: $1.50 (0.15%)
- 시나리오 4: $3.00 (0.30%)
- 시나리오 5: $2.50 (0.25%)
- 시나리오 6: $6.00 (0.60%)

누적 비용:
- 최소 비용: $0.70
- 일반 비용: $1.50
- 높은 비용: $3.00
- 극단 비용: $6.00

비용이 수익률에 미치는 영향:
거래 수가 1회로 매우 적어 비용 영향 제한적
하지만 거래 빈도 증가 시 비용이 기하급수적으로 증가

==========================================
주문 유형 비교 (이론적 분석)
==========================================

Market Order (시장가):
- 장점: 확실한 체결
- 단점: 슬리피지 높음 (0.1-0.3%)
- 적합: 유동성 높은 종목, 긴급 청산

Limit Order (지정가):
- 장점: 가격 통제, 슬리피지 최소
- 단점: 미체결 위험 10-20%
- 적합: 비급한 거래, 큰 포지션

Stop Loss Order:
- 장점: 자동 리스크 관리
- 단점: 갭 발생 시 큰 슬리피지
- 적합: 리스크 관리 필수 시

==========================================
시장 영향 (Market Impact)
==========================================

NVDA 평균 일일 거래량: 약 300M주
$10,000 포지션 ≈ 20-30주
→ 시장 영향 무시 가능 (< 0.00001%)

포지션 크기가 일평균 거래량의:
- < 1%: 영향 무시 가능
- 1-5%: 작은 영향 (0.05-0.2% 슬리피지)
- 5-10%: 중간 영향 (0.2-0.5%)
- > 10%: 큰 영향 (0.5-2%)

==========================================
결론
==========================================

이 테스트 케이스의 특수성:
- 거래 수 1회 → 비용 영향 미미
- 실제 빈번한 거래 전략에서는 비용이 치명적!

예상 비용 영향 (일반적 케이스):
- 월 10회 거래 × 12개월 = 120회/년
- 수수료 0.1% + 슬리피지 0.05% = 0.15%/거래
- 120회 × 0.15% = 18% 연간 비용!
→ 전략이 18% 이상 수익 내야 손익분기

교훈:
1. 거래 빈도 ↑ → 비용 영향 기하급수적 ↑
2. 슬리피지는 수수료보다 예측 어려움
3. 페이퍼 트레이딩으로 실제 비용 측정 필수

==========================================
결과 저장 완료
==========================================
차트: codes/chapter17/images/trading_costs_impact.png
```

![거래 비용 영향 분석](/images/chapter17/trading_costs_impact.png)

### 차트 해석

**좌상단 패널 - 시나리오별 자산 곡선**:
- 모든 6개 시나리오의 곡선이 **거의 겹쳐 있습니다**
- 이는 거래가 단 1회만 발생했기 때문입니다
- 1회 거래에서 0.07%-0.60% 비용은 최종 자산에 미미한 영향만 줍니다
- **중요한 교훈**: 이 결과만 보고 "비용이 중요하지 않네"라고 착각하면 안 됩니다!

**우상단 패널 - 거래 비용 누적 영향**:
- Y축 스케일이 -$6 ~ $0으로 매우 작습니다
- 극단적 슬리피지(0.5%)도 누적 비용이 단 $6입니다
- **거래 1회의 한계**: 비용 영향을 제대로 관찰할 수 없습니다
- 실제 빈번한 거래 전략(연 100-200회)에서는 수천 달러로 증가합니다

**좌하단 패널 - 수수료 vs. 슬리피지 비교**:
- 수수료(파란 막대)는 명확하고 예측 가능합니다
- 슬리피지(주황 막대)는 변동성이 크고 예측 어렵습니다
- 극단적 슬리피지(0.5%)는 수수료(0.1%)의 5배입니다
- **교훈**: 슬리피지가 수수료보다 더 위험한 변수입니다

**우하단 패널 - 수익률 비교 (%)** :
- 모든 시나리오가 0%에 매우 가깝습니다 (+0.03% ~ -0.03%)
- 시나리오 간 차이가 거의 없어 보입니다
- **시각적 한계**: 거래 빈도가 낮아 비용 영향이 그래프에 나타나지 않습니다

### 핵심 인사이트

**1. 이 테스트의 특수성**
- **거래 1회** → 비용 영향 최소화됨
- 이는 **SMA 50/200 장기 전략 + NVDA의 특수한 가격 움직임** 결과입니다
- **일반화하면 안 됩니다!**

**2. 실제 거래 비용의 위력 (시뮬레이션)**
- 월 10회 거래 전략 가정:
  ```
  연간 거래: 120회
  거래당 비용: 0.15% (수수료 0.1% + 슬리피지 0.05%)
  연간 비용: 120 × 0.15% = 18%

  전략 수익률이 25%라면:
  실제 수익 = 25% - 18% = 7%
  → 비용이 수익의 72%를 잠식!
  ```

**3. 슬리피지의 예측 불가능성**
- 수수료는 고정(0.1%)이지만, 슬리피지는 **0.02%-0.50%로 25배 차이**
- 변동성, 유동성, 주문 크기, 시간대에 따라 변합니다
- **페이퍼 트레이딩으로 실측 필수**

**4. 거래 빈도와 비용의 기하급수적 관계**
- 거래 1회: 비용 영향 0.01-0.06%
- 거래 10회: 비용 영향 0.1-0.6%
- 거래 100회: 비용 영향 1-6%
- 거래 1000회 (데이 트레이딩): **비용 영향 10-60%!**

**5. 주문 유형의 트레이드오프**
- **Market Order**: 체결 확실 ✓, 슬리피지 높음 ✗
- **Limit Order**: 슬리피지 낮음 ✓, 미체결 위험 ✗
- 전략 특성에 따라 선택:
  - 급한 손절매 → Market Order
  - 여유있는 진입 → Limit Order

**6. 시장 영향의 규모별 차이**
| 포지션 크기 | 일평균 거래량 % | 슬리피지 예상 | 투자자 유형 |
|-----------|---------------|-------------|-----------|
| $1만 | < 0.001% | 무시 가능 | 개인 |
| $10만 | 0.01% | 0.05-0.1% | 개인 대량 |
| $100만 | 0.1% | 0.1-0.3% | 소형 펀드 |
| $1000만 | 1% | 0.3-1% | 중형 펀드 |
| $1억+ | 10%+ | 1-5% | 대형 펀드 |

**7. 백테스트 vs. 실전 격차**
- **백테스트**: 이상적 가격에 즉시 체결 가정
- **실전**:
  - 주문 전송 지연 (0.1-0.5초)
  - 거래소 매칭 지연 (0.01-0.1초)
  - 부분 체결 (10-30% 확률)
  - 호가 스프레드 (0.01-0.1%)
  - 갭 발생 시 큰 슬리피지 (1-5%)

**8. 손익분기 계산의 중요성**
- 전략이 몇 % 수익을 내야 실제 수익이 날까?
  ```
  필요 수익률 = 거래 횟수 × (수수료 + 슬리피지)

  월 10회 거래:
  필요 = 10 × 0.15% = 1.5% (월간)
  → 연간 18% 이상 수익 필수!
  ```

### 실전 적용 가이드

**거래 비용 최소화 전략**:

**1. 거래 빈도 줄이기**
- 단기(일간) 전략 → 중기(주간) 전략으로 전환
- 필터 추가로 거짓 신호 제거
- 목표: 월 5회 이하

**2. 주문 유형 최적화**
```python
# 진입: 여유있게 Limit Order
if buy_signal:
    limit_price = current_price * 0.998  # 0.2% 아래
    self.buy(exectype=bt.Order.Limit, price=limit_price)

# 손절: 급하게 Market Order
if stop_loss_triggered:
    self.sell(exectype=bt.Order.Market)
```

**3. 유동성 고려**
- 거래량 > 100만주/일 종목 선택
- 장 시작/마감 30분 피하기 (스프레드 넓음)
- 큰 포지션은 여러 주문으로 분할

**4. 브로커 선택**
| 브로커 유형 | 수수료 | 슬리피지 | 적합 투자자 |
|----------|--------|---------|-----------|
| 저가 온라인 | 0.05-0.1% | 높음 | 장기 투자 |
| 중간급 | 0.1-0.2% | 중간 | 일반 투자 |
| 프리미엄 | 0.2-0.3% | 낮음 | 대량 거래 |

**5. 백테스트 설정**
```python
# 보수적 비용 설정
cerebro.broker.setcommission(
    commission=0.002,  # 0.2% (높게 설정)
    slippage_perc=0.001  # 0.1% (높게 설정)
)
```
→ 실전보다 **높게** 설정하여 안전 마진 확보

**거래 비용 체크리스트**:
- [ ] 백테스트에 최소 0.15% 비용 반영 (수수료 + 슬리피지)
- [ ] 거래 빈도 월 10회 이하로 제한
- [ ] 손익분기 수익률 계산
- [ ] 페이퍼 트레이딩으로 실제 슬리피지 측정 (최소 3개월)
- [ ] 유동성 충분한 종목만 거래 (일평균 거래량 > 100만주)
- [ ] 시장 영향 < 일평균 거래량의 1%
- [ ] 주문 유형 전략 수립 (진입/청산 별도)

**경고 신호**:
- 연간 거래 횟수 > 500회 → 비용으로 수익 불가능
- 슬리피지 실측 > 0.3% → 전략 수정 또는 종목 변경
- 페이퍼 vs. 백테스트 격차 > 20% → 비용 모델링 오류

### 그렇다면 이 전략은?

이 SMA 50/200 전략의 문제:
1. **거래 빈도**: 1회 (너무 적음 → 기회 놓침)
2. **타이밍**: 1회 거래가 최악의 시점
3. **비용 영향**: 미미하지만 수익도 미미 (+0.03%)

**결론**: 비용 문제가 아니라 **전략 자체가 작동 안 함**

더 큰 문제:
- 거래 1회로 $10,000 → $10,003 (+0.03%)
- Buy & Hold: $10,000 → $250,000+ (+2,400%)
- **기회비용 -$240,000**

거래 비용을 걱정하기 전에, 먼저 **제대로 작동하는 전략**을 만들어야 합니다!

## 연습 문제

1. 자신의 전략에 슬리피지 0.05%와 수수료 0.1%를 추가하고, 성과 변화를 측정해보세요.
2. 시장 체제 감지 알고리즘을 구현하고, 체제별 전략 성과를 비교해보세요.
3. 다양한 주문 유형(Market, Limit)을 사용했을 때 체결률과 성과를 비교해보세요.
